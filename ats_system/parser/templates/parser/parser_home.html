{% extends 'landing/base.html' %}

{% block title %}Resume Parser - Jumaiya ATS{% endblock %}

{% block content %}
<div id="wrapper">
    <button class="btn btn-primary" id="menu-open" style="display: none;">&rarr;</button>
    <div class="bg-dark border-right" id="sidebar-wrapper">
        <div class="sidebar-heading">
            <span>Parser Menu</span>
            <button class="btn btn-dark float-end" id="menu-close">&larr;</button>
        </div>
        <div class="list-group list-group-flush">
            <a href="#" class="list-group-item list-group-item-action bg-dark text-white" id="dashboard-link">Dashboard</a>
            <a href="#" class="list-group-item list-group-item-action bg-dark text-white" id="upload-resume-link">Upload Resume</a>
            <a href="#" class="list-group-item list-group-item-action bg-dark text-white" id="candidates-link">Candidates</a>
            <a href="#" class="list-group-item list-group-item-action bg-dark text-white">Settings</a>
        </div>
    </div>
    <div id="page-content-wrapper">
        <div id="dashboard-content">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <h1 class="mt-4">Welcome to the Parser!</h1>
            </nav>
            <div class="container-fluid">
                <p>This is where the main content of your resume parser will go.</p>
            </div>
        </div>

        <div id="upload-resume-content" style="display: none;">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <h1 class="mt-4">Upload Resumes</h1>
            </nav>
            <div class="container-fluid">
                <form id="upload-form" action="{% url 'upload_resume' %}" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="resume-upload" class="form-label">Select one or more files (PDF, JPEG, PNG, DOCX):</label>
                        <input class="form-control" type="file" id="resume-upload" name="resumes" multiple accept=".pdf,.jpeg,.jpg,.png,.docx">
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>

                <div id="loading-animation" style="display: none;" class="mt-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div id="gemini-output" class="mt-4" style="display: none;">
                            <h3>Gemini Raw Text Response:</h3>
                            <pre><code></code></pre>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div id="parsed-output" class="mt-4" style="display: none;">
                            <h3>Parsed JSON Output:</h3>
                            <pre><code></code></pre>
                        </div>
                    </div>
                </div>

                {% if csv_output %}
                <div class="mt-4">
                    <h3>Gemini JSON Output:</h3>
                    <pre><code>{{ csv_output }}</code></pre>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="candidates-content" style="display: none;">
            <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
                <h1 class="mt-4">Candidates</h1>
            </nav>
            <div class="container-fluid">
                <form id="filter-form" method="get" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <input type="text" name="first_name" class="form-control" placeholder="First Name" value="{{ request.GET.first_name }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="last_name" class="form-control" placeholder="Last Name" value="{{ request.GET.last_name }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="date_of_birth" class="form-control" placeholder="DOB (YYYY-MM-DD)" value="{{ request.GET.date_of_birth }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="degree" class="form-control" placeholder="Degree" value="{{ request.GET.degree }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="degree_school" class="form-control" placeholder="Degree School" value="{{ request.GET.degree_school }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="diploma" class="form-control" placeholder="Diploma" value="{{ request.GET.diploma }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="diploma_school" class="form-control" placeholder="Diploma School" value="{{ request.GET.diploma_school }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" name="resume_file_name" class="form-control" placeholder="Resume File" value="{{ request.GET.resume_file_name }}">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary">Filter</button>
                            <a href="{% url 'parser_home' %}" class="btn btn-secondary">Clear</a>
                        </div>
                    </div>
                </form>

                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col"><a href="?sort_by=id&order={% if request.GET.sort_by == 'id' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">c_id</a></th>
                            <th scope="col"><a href="?sort_by=first_name&order={% if request.GET.sort_by == 'first_name' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">First Name</a></th>
                            <th scope="col"><a href="?sort_by=last_name&order={% if request.GET.sort_by == 'last_name' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">Last Name</a></th>
                            <th scope="col"><a href="?sort_by=date_of_birth&order={% if request.GET.sort_by == 'date_of_birth' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">DOB</a></th>
                            <th scope="col"><a href="?sort_by=degree&order={% if request.GET.sort_by == 'degree' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">Degree</a></th>
                            <th scope="col"><a href="?sort_by=degree_school&order={% if request.GET.sort_by == 'degree_school' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">Degree School</a></th>
                            <th scope="col"><a href="?sort_by=diploma&order={% if request.GET.sort_by == 'diploma' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">Diploma</a></th>
                            <th scope="col"><a href="?sort_by=diploma_school&order={% if request.GET.sort_by == 'diploma_school' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">Diploma School</a></th>
                            <th scope="col"><a href="?sort_by=resume_file_name&order={% if request.GET.sort_by == 'resume_file_name' and request.GET.order == 'asc' %}desc{% else %}asc{% endif %}">Resume File Name</a></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for candidate in candidates %}
                        <tr>
                            <th scope="row">{{ candidate.id }}</th>
                            <td>{{ candidate.first_name|default_if_none:"" }}</td>
                            <td>{{ candidate.last_name|default_if_none:"" }}</td>
                            <td>{{ candidate.date_of_birth|default_if_none:"" }}</td>
                            <td>{{ candidate.degree|default_if_none:"" }}</td>
                            <td>{{ candidate.degree_school|default_if_none:"" }}</td>
                            <td>{{ candidate.diploma|default_if_none:"" }}</td>
                            <td>{{ candidate.diploma_school|default_if_none:"" }}</td>
                            <td>{{ candidate.resume_file_name }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="9">No candidates found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        overflow-x: hidden;
    }

    #wrapper {
        display: flex;
        transition: all 0.3s ease;
    }

    #sidebar-wrapper {
        min-height: 100vh;
        width: 15rem;
        position: fixed;
        left: 0;
        z-index: 1030;
        transition: transform 0.3s ease;
        transform: translateX(0);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    #wrapper.toggled #sidebar-wrapper {
        transform: translateX(-15rem);
    }

    #page-content-wrapper {
        width: 100%;
        padding-left: 15rem; /* Same as sidebar width */
        transition: padding-left 0.3s ease;
    }

    #wrapper.toggled #page-content-wrapper {
        padding-left: 0;
    }

    #sidebar-wrapper .sidebar-heading {
        padding: 0.875rem 1.25rem;
        font-size: 1.2rem;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #menu-open {
        position: fixed;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1031;
    }

    .list-group-item-action.bg-dark.text-white {
        transition: all 0.2s ease-in-out;
    }

    .list-group-item-action.bg-dark.text-white:hover {
        background-color: #343a40 !important;
        color: white !important;
        box-shadow: 0 0 10px #ffd700;
        transform: scale(1.02);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const menuClose = document.getElementById('menu-close');
        const menuOpen = document.getElementById('menu-open');
        const wrapper = document.getElementById('wrapper');
        const isSidebarToggled = localStorage.getItem('isSidebarToggled') === 'true';

        const dashboardLink = document.getElementById('dashboard-link');
        const uploadResumeLink = document.getElementById('upload-resume-link');
        const candidatesLink = document.getElementById('candidates-link');

        const dashboardContent = document.getElementById('dashboard-content');
        const uploadResumeContent = document.getElementById('upload-resume-content');
        const candidatesContent = document.getElementById('candidates-content');

        // Function to show a specific section and hide others
        const showSection = (sectionToShow) => {
            [dashboardContent, uploadResumeContent, candidatesContent].forEach(section => {
                section.style.display = 'none';
            });
            sectionToShow.style.display = 'block';
            localStorage.setItem('activeSection', sectionToShow.id);
        };

        // Check local storage for the active section on page load
        const activeSectionId = localStorage.getItem('activeSection');
        if (activeSectionId) {
            const sectionToShow = document.getElementById(activeSectionId);
            if (sectionToShow) {
                showSection(sectionToShow);
            } else {
                showSection(dashboardContent); // Default to dashboard if ID is invalid
            }
        } else {
            showSection(dashboardContent); // Default to dashboard
        }


        if (isSidebarToggled) {
            wrapper.classList.add('toggled');
            menuOpen.style.display = 'block';
        }

        menuClose.addEventListener('click', (e) => {
            e.preventDefault();
            wrapper.classList.add('toggled');
            localStorage.setItem('isSidebarToggled', 'true');
            menuOpen.style.display = 'block';
        });

        menuOpen.addEventListener('click', (e) => {
            e.preventDefault();
            wrapper.classList.remove('toggled');
            localStorage.setItem('isSidebarToggled', 'false');
            menuOpen.style.display = 'none';
        });

        dashboardLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(dashboardContent);
        });

        uploadResumeLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(uploadResumeContent);
        });

        candidatesLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(candidatesContent);
        });

        const uploadForm = document.getElementById('upload-form');
        const loadingAnimation = document.getElementById('loading-animation');
        const geminiOutput = document.getElementById('gemini-output');
        const geminiOutputCode = geminiOutput.querySelector('code');
        const parsedOutput = document.getElementById('parsed-output');
        const parsedOutputCode = parsedOutput.querySelector('code');

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingAnimation.style.display = 'block';
            geminiOutput.style.display = 'none';
            parsedOutput.style.display = 'none';

            const formData = new FormData(uploadForm);
            const response = await fetch(uploadForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            const data = await response.json();

            loadingAnimation.style.display = 'none';
            if (data.csv_output) {
                geminiOutputCode.textContent = data.csv_output;
                geminiOutput.style.display = 'block';
            }
            if (data.parsed_data) {
                parsedOutputCode.textContent = JSON.stringify(data.parsed_data, null, 2);
                parsedOutput.style.display = 'block';
            }
        });
    });
</script>
{% endblock %}